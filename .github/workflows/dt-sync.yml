name: Main → Dependency-Track Sync

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dt-sync:
    runs-on: ubuntu-latest
    env:
      DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
      DT_API_KEY:  ${{ secrets.DT_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 1) SBOM 生成（Trivy でも Syft でもOK。ここは Trivy 例）
      - name: Generate SBOM (CycloneDX JSON)
        run: |
          mkdir -p artifacts
          docker run --rm -v "$PWD":/work aquasec/trivy:latest fs \
            --format cyclonedx \
            --output /work/artifacts/sbom.json \
            /work

      # 2) SBOM から projectName / projectVersion を抽出（2ホップ法）
      - name: Derive projectName / projectVersion from SBOM
        id: meta
        run: |
          set -e
          ROOT_REF=$(jq -r '.metadata.component["bom-ref"]' artifacts/sbom.json)
          POM_REF=$(jq -r --arg rr "$ROOT_REF" '
            .dependencies[] | select(.ref==$rr) | .dependsOn[]' artifacts/sbom.json)
          SELF_REF=$(jq -r --arg pr "$POM_REF" '
            .dependencies[] | select(.ref==$pr) | .dependsOn[]' artifacts/sbom.json)

          PN=$(jq -r --arg sr "$SELF_REF" '.components[] | select(."bom-ref"==$sr) | .name' artifacts/sbom.json)
          PV=$(jq -r --arg sr "$SELF_REF" '.components[] | select(."bom-ref"==$sr) | .version' artifacts/sbom.json)

          if [ -z "$PN" ] || [ -z "$PV" ] || [ "$PN" = "null" ] || [ "$PV" = "null" ]; then
            echo "SBOM から name/version を特定できませんでした" >&2
            exit 1
          fi
          echo "projectName=$PN"   >> $GITHUB_OUTPUT
          echo "projectVersion=$PV" >> $GITHUB_OUTPUT
          echo "Detected PN=$PN PV=$PV"

      # 3) /v1/bom にアップロード（autoCreate=true で未存在は自動作成）
      - name: Upload SBOM to Dependency-Track
        run: |
          curl -sS -X POST "$DT_BASE_URL/v1/bom" \
            -H "X-Api-Key: $DT_API_KEY" \
            -F "autoCreate=true" \
            -F "projectName=${{ steps.meta.outputs.projectName }}" \
            -F "projectVersion=${{ steps.meta.outputs.projectVersion }}" \
            -F "bom=@artifacts/sbom.json"

      - name: List active DT project versions (inactive candidates)
        run: |
          PN="${{ steps.meta.outputs.projectName }}"
          CUR="${{ steps.meta.outputs.projectVersion }}"

          echo "## Dependency-Track active versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RESP=$(curl -sS \
            "$DT_BASE_URL/v1/project?name=$(printf %s "$PN" | jq -sRr @uri)&excludeInactive=true" \
            -H "X-Api-Key: $DT_API_KEY")

          # active な version 一覧
          ACTIVE=$(echo "$RESP" | jq -r '.[].version')

          echo "**Current version:** \`$CUR\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Active versions in DT:**" >> $GITHUB_STEP_SUMMARY
          for v in $ACTIVE; do
            echo "- $v" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # inactive 候補（current 以外）
          CANDIDATES=$(echo "$ACTIVE" | grep -v "^$CUR$" || true)

          if [ -n "$CANDIDATES" ]; then
            echo "### ⚠️ Inactive candidates" >> $GITHUB_STEP_SUMMARY
            for v in $CANDIDATES; do
              echo "- **$v**" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "➡️ If safe, deactivate via:" >> $GITHUB_STEP_SUMMARY
            echo "\`Actions > Deactivate DT Project Version\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No inactive candidates found." >> $GITHUB_STEP_SUMMARY
          fi
