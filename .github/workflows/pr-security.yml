name: PR Security (SBOM + Report)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ï¼ˆä»»æ„ï¼‰ãƒ¢ãƒãƒ¬ãƒã‚„å·¨å¤§ãƒªãƒã‚¸ãƒˆãƒªã§ Trivy ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ãŸã„ã¨ã
      - name: Cache Trivy data
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}

      - name: Generate SBOM (CycloneDX JSON) with Trivy (lightweight)
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v "$PWD":/work \
            aquasec/trivy:latest fs \
              --format cyclonedx \
              --output /work/artifacts/sbom.json \
              /work

      # High / Critical ã®ã¿ã® HTML ãƒ¬ãƒãƒ¼ãƒˆï¼ˆäººé–“å‘ã‘ï¼‰
      - name: Render HTML report (High/Critical)
        run: |
          docker run --rm \
            -v "$PWD":/work \
            aquasec/trivy:latest sbom \
              --severity HIGH,CRITICAL \
              --format template \
              --template "@contrib/html.tpl" \
              --output /work/artifacts/trivy-report-high-critical.html \
              /work/artifacts/sbom.json

      # JSON ã§ç·æ•°ã‚’é›†è¨ˆã—ã¦ PR ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ã‚µãƒãƒªã‚’ä½œã‚‹
      - name: Compute summary (all severities)
        id: summary
        run: |
          docker run --rm \
            -v "$PWD":/work \
            aquasec/trivy:latest sbom \
              --format json \
              /work/artifacts/sbom.json > artifacts/trivy-result.json

          # jq ã§ä»¶æ•°ã‚’é›†è¨ˆï¼ˆseverity ãŒç„¡ã„å ´åˆã¯ 0 ã«ï¼‰
          CRITICAL=$(jq '[.[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' artifacts/trivy-result.json)
          HIGH=$(jq '[.[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' artifacts/trivy-result.json)
          MEDIUM=$(jq '[.[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' artifacts/trivy-result.json)
          LOW=$(jq '[.[].Vulnerabilities[]? | select(.Severity=="LOW")] | length' artifacts/trivy-result.json)
          UNKNOWN=$(jq '[.[].Vulnerabilities[]? | select(.Severity=="UNKNOWN")] | length' artifacts/trivy-result.json)
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW + UNKNOWN))

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "unknown=$UNKNOWN" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Upload artifacts (HTML + SBOM + JSON)
        uses: actions/upload-artifact@v4
        with:
          name: pr-security-report
          path: |
            artifacts/trivy-report-high-critical.html
            artifacts/sbom.json
            artifacts/trivy-result.json
          if-no-files-found: error
          retention-days: 14

      # åŒã˜ã‚¿ã‚°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆé‡è¤‡æŠ•ç¨¿ã—ãªã„å·¥å¤«ï¼‰
      - name: Create/Update PR comment (summary + link to artifacts)
        uses: actions/github-script@v7
        with:
          script: |
            const { critical, high, medium, low, unknown, total } = {
              critical: process.env.CRITICAL,
              high: process.env.HIGH,
              medium: process.env.MEDIUM,
              low: process.env.LOW,
              unknown: process.env.UNKNOWN,
              total: process.env.TOTAL
            };

            // Artifact ç›´ãƒªãƒ³ã‚¯ã¯å®Ÿè¡Œå±¥æ­´ãƒšãƒ¼ã‚¸çµŒç”±ã«ãªã‚‹ã®ã§ã€ã“ã“ã§ã¯èª¬æ˜ã‚’è¨˜è¼‰
            const body = `
            <!-- sbom-trivy-summary -->
            ğŸ” **Dependency Security (SBOM-based) / PR Summary**

            - **Critical**: ${critical}
            - **High**: ${high}
            - Medium: ${medium}
            - Low: ${low}
            - Unknown: ${unknown}
            - **Total**: ${total}

            ğŸ“„ **HTML ãƒ¬ãƒãƒ¼ãƒˆ (High/Critical)** ã¯ **Artifacts** ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š  
            **Actions â†’ ã“ã®ã‚¸ãƒ§ãƒ– â†’ Artifacts â†’ \`pr-security-report\` â†’ \`trivy-report-high-critical.html\`**

            ğŸ§¾ SBOM (CycloneDX JSON): \`sbom.json\`  
            ğŸ§ª ç”Ÿãƒ‡ãƒ¼ã‚¿ (JSON): \`trivy-result.json\`

            > ãƒ¡ãƒ¢: ã“ã‚Œã¯ã€ŒPR å‘ã‘ã®å³æ™‚ãƒã‚§ãƒƒã‚¯ã€ã§ã™ã€‚æ­£å¼ãª DT æ›´æ–°ã¯ \`main\` ãƒãƒ¼ã‚¸æ™‚ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è¡Œã‚ã‚Œã¾ã™ã€‚
            `;

            const { context, github } = require('@actions/github');
            const issue_number = context.payload.pull_request ? context.payload.pull_request.number : null;
            if (!issue_number) {
              core.info('No PR context; skipping comment.');
              return;
            }

            // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™ï¼ˆã‚¿ã‚°ã§è­˜åˆ¥ï¼‰
            const { data: comments } = await github.rest.issues.listComments({
              ...context.repo,
              issue_number
            });

            const tag = '<!-- sbom-trivy-summary -->';
            const existing = comments.find(c => c.body && c.body.includes(tag));

            if (existing) {
              await github.rest.issues.updateComment({
                ...context.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number,
                body
              });
            }
        env:
          CRITICAL: ${{ steps.summary.outputs.critical }}
          HIGH: ${{ steps.summary.outputs.high }}
          MEDIUM: ${{ steps.summary.outputs.medium }}
          LOW: ${{ steps.summary.outputs.low }}
          UNKNOWN: ${{ steps.summary.outputs.unknown }}
          TOTAL: ${{ steps.summary.outputs.total }}
